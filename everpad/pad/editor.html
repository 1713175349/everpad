<!DOCTYPE html>
<html>
<style type='text/css'>
    .tab {
        margin-left: 12px;
        width: 0px;
        height: 0px;
        display: inline-block
    }
</style>
<body>
<form>
<h2 
    contenteditable="true"
    id='title'>%(title)s</h2>
<div 
    contenteditable="true"
    id='content'>%(content)s</div>
</form>
<script type="text/javascript">
    var isContent = false;
    var currentLink = undefined;
    function insertEl(el) {
        var _this = document.getElementById('content');
        try {
            if (!isContent) throw 1;
            var selection = window.getSelection();
            var range = selection.getRangeAt(0);
            range.collapse(false);
            range.deleteContents();
            range.insertNode(el);
            range = range.cloneRange();
            range.setStart(el, 0);
            range.setEndAfter(el);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
        } catch (Exception) {
            _this.appendChild(el);
        }
    }
    function insertCheck() {
        var el = document.createElement('input');
        el.setAttribute('type', 'checkbox');
        el.addEventListener('change', function() {
            console.log("change");
            this.setAttribute("checked", this.checked);
        }, false);
        insertEl(el);
    }
    function insertRes(filePath, hash, mime) {
        var el = document.createElement("img");
        el.setAttribute('src', 'file://' + filePath);
        el.setAttribute('hash', hash);
        el.setAttribute('type', mime)
        el.addEventListener('contextmenu', function(event){
            console.log('context:' + hash + ':' + el.width + ':' + el.height);
        }, false);
        insertEl(el);
    }
    function insertLink(url) {
        var range = window.getSelection().getRangeAt(0),
            content = range.extractContents(),
            link = document.createElement('a');
        if (!content.textContent)
            content = document.createTextNode(url);
        link.appendChild(content);
        link.setAttribute('href', url);
        insertEl(link);
        link.addEventListener('contextmenu', function() {
                console.log('href:' + url);
                currentLink = link;
        }, false);
    }
    function changeLink(url) {
        currentLink.setAttribute('href', url);
    }
    function removeLink() {
        while (currentLink.firstChild)
            currentLink.parentNode.insertBefore(currentLink.firstChild,
                currentLink
            );
        currentLink.parentNode.removeChild(currentLink);
    }
    function changeRes(hash, width, height) {
        var el = document.querySelector('[hash="' + hash + '"]');
        el.setAttribute('width', width);
        el.setAttribute('height', height);
    }
    var content = document.getElementById('content');
    content.addEventListener('focus', function() {
        console.log("body");
        isContent = true;
    }, false);
    content.addEventListener('keydown', function(event) {
        if (event.keyCode == 9){
            event.preventDefault();
            var el = document.createElement("img");
            el.className = "tab";
            insertEl(el);
            console.log("change");
            return false;
        }
    }, false);
    var title = document.getElementById('title');
    title.addEventListener('focus', function() {
        console.log("head");
        isContent = false;
    }, false);
    var checkboxes = document.querySelectorAll('input[type=checkbox]');
    [].forEach.call(checkboxes, function(el){
        el.addEventListener('change', function() {
        console.log("change");
        this.setAttribute("checked", this.checked);
    }, false);});
    var resources = document.querySelectorAll('img[hash]');
    [].forEach.call(resources, function(el){
        el.addEventListener('contextmenu', function() {
            console.log('context:' + el.getAttribute('hash') + ':' + el.width + ':' + el.height);
    }, false);});
    var links = document.querySelectorAll('a');
    [].forEach.call(links, function(el){
        el.addEventListener('contextmenu', function() {
            console.log('href:' + el.getAttribute('href'));
            currentLink = el;
    }, false);});
</script>
</body>
</html>